{% extends "base.html" %}

{% block title %}AIスコア入力 - {{ super() }}{% endblock %}

{% block content %}
<article>
    <header>
        <h2>今日の活動ログ</h2>
        <p>今日一日の活動内容を具体的に入力してください。AIが生産性スコアを採点します。</p>
        <p>これ以前に入力した今日のログも参照されます。毎回1日のはじめから書く必要はありません。</p>
    </header>
    <form id="evaluation-form">
        <label for="date">
            日付
            <input type="date" id="date" name="date" required>
        </label>
        <label for="log-text">
            活動ログ
            <textarea id="log-text" name="log-text" rows="8" placeholder="（例）午前中はXXのタスクに集中して取り組み、3時間で完了させた。午後は会議が2つあり、その後はメール対応に追われた。夜は新しい技術のドキュメントを読んだ。" required></textarea>
        </label>
        <button type="submit" id="evaluate-btn">AIに採点を依頼する</button>
    </form>
    
    <div id="result-container" style="display: none; margin-top: 1.5rem;">
        <h3>AIによる採点結果</h3>
        <p><strong>スコア:</strong> <mark><span id="result-score"></span></mark> / 100</p>
        <p><strong>コメント:</strong> <span id="result-comment"></span></p>
        <div id="save-status"></div>
    </div>
</article>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const evaluationForm = document.getElementById('evaluation-form');
    const evaluateBtn = document.getElementById('evaluate-btn');
    const dateInput = document.getElementById('date');
    const logTextInput = document.getElementById('log-text');
    
    const resultContainer = document.getElementById('result-container');
    const resultScore = document.getElementById('result-score');
    const resultComment = document.getElementById('result-comment');
    const saveStatus = document.getElementById('save-status');

    // Set today's date by default
    const toISODateString = (date) => date.toLocaleDateString('en-CA');
    dateInput.value = toISODateString(new Date());

    evaluationForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        
        const logText = logTextInput.value;
        const logDate = dateInput.value;

        if (!logText.trim()) {
            alert('活動ログを入力してください。');
            return;
        }

        // --- Step 1: Get AI Evaluation ---
        evaluateBtn.setAttribute('aria-busy', 'true');
        evaluateBtn.disabled = true;
        saveStatus.textContent = 'AIが採点中です...';
        resultContainer.style.display = 'none';

        try {
            const evaluateResponse = await fetch('/api/evaluate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ log_text: logText, date: logDate }),
            });

            if (!evaluateResponse.ok) {
                const errorResult = await evaluateResponse.json();
                throw new Error(`AIの採点に失敗しました: ${errorResult.details || '不明なエラー'}`);
            }

            const evaluation = await evaluateResponse.json();
            
            // Display AI evaluation results
            resultScore.textContent = evaluation.score;
            resultComment.textContent = evaluation.comment;
            resultContainer.style.display = 'block';
            saveStatus.textContent = '採点が完了しました。結果を保存しています...';
            
            // Update textarea with the full log that was evaluated
            logTextInput.value = evaluation.combined_log;

            // --- Step 2: Save the log with the AI-generated score ---
            const dataToSave = {
                date: logDate,
                score: evaluation.score,
                note: evaluation.combined_log, // Save the combined log text as the note
            };

            const saveResponse = await fetch('/api/score', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dataToSave),
            });

            const saveResult = await saveResponse.json();
            
            if (saveResponse.ok && saveResult.success) {
                saveStatus.innerHTML = `<mark class="success">ログの保存に成功しました！</mark>`;
                // On successful save, we don't reset the form immediately
                // so the user can add more logs to the same day.
                // The textarea already contains the full combined log.
                // We just clear the status message after a delay.
                setTimeout(() => {
                   saveStatus.innerHTML = '';
                }, 5000);
            } else {
                throw new Error(saveResult.error || 'データベースへの保存中にエラーが発生しました。');
            }

        } catch (error) {
            saveStatus.innerHTML = `<mark class="error">エラー: ${error.message}</mark>`;
            resultContainer.style.display = 'block'; // Show container to display the error message
        } finally {
            evaluateBtn.setAttribute('aria-busy', 'false');
            evaluateBtn.disabled = false;
        }
    });
});
</script>
{% endblock %}
