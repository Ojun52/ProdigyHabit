{% extends "base.html" %}

{% block title %}スコア入力 - {{ super() }}{% endblock %}

{% block content %}
<article>
    <header>
        <h2>生産性ログを追加</h2>
    </header>
    <form id="score-form">
        <label for="date">
            日付
            <input type="date" id="date" name="date" required>
        </label>
        <label for="score">
            スコア (0-100)
            <input type="number" id="score" name="score" min="0" max="100" required>
        </label>
        <label for="note">
            メモ
            <textarea id="note" name="note" rows="5" placeholder="（例）集中して作業できた"></textarea>
        </label>
        <button type="submit">ログを保存</button>
    </form>
    <div id="save-status"></div>
</article>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const scoreForm = document.getElementById('score-form');
    const saveStatus = document.getElementById('save-status');
    const dateInput = document.getElementById('date');

    const toISODateString = (date) => date.toLocaleDateString('en-CA');
    dateInput.value = toISODateString(new Date());

    scoreForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        
        const data = {
            date: document.getElementById('date').value,
            score: parseInt(document.getElementById('score').value, 10),
            note: document.getElementById('note').value,
        };

        try {
            const response = await fetch('/api/score', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });

            const result = await response.json();
            
            if (response.ok && result.success) {
                saveStatus.innerHTML = `<mark class="success">成功: ${result.message || 'スコアを保存しました。'}</mark>`;
                scoreForm.reset();
                dateInput.value = toISODateString(new Date());
            } else {
                throw new Error(result.error || '不明なエラー');
            }
        } catch (error) {
            saveStatus.innerHTML = `<mark class="error">エラー: ${error.message}</mark>`;
        }
    });
});
</script>
{% endblock %}
