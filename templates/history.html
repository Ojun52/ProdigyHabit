{% extends "base.html" %}

{% block title %}スコア履歴 - {{ super() }}{% endblock %}

{% block content %}
<article>
    <header>
        <h2>スコア履歴</h2>
    </header>

    <div class="grid">
        <button id="prev-week-btn" class="outline">&lt; 前の週</button>
        <div style="text-align: center; line-height: 2.5rem;" id="week-display"></div>
        <button id="next-week-btn" class="outline">次の週 &gt;</button>
    </div>

    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th>日付</th>
                    <th>曜日</th>
                    <th>スコア</th>
                    <th>メモ</th>
                </tr>
            </thead>
            <tbody id="scores-tbody">
                <!-- Weekly score history will be populated here -->
            </tbody>
        </table>
    </div>
</article>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const scoresTbody = document.getElementById('scores-tbody');
    const prevWeekBtn = document.getElementById('prev-week-btn');
    const nextWeekBtn = document.getElementById('next-week-btn');
    const weekDisplay = document.getElementById('week-display');

    let currentDate = new Date();
    const dayNames = ['日', '月', '火', '水', '木', '金', '土'];

    const toISODateString = (date) => date.toLocaleDateString('en-CA');

    const fetchAndDisplayScores = async (date) => {
        const dateParam = toISODateString(date);
        scoresTbody.innerHTML = `<tr><td colspan="4"><progress></progress></td></tr>`;
        try {
            const response = await fetch(`/api/scores?date=${dateParam}`);
            if (!response.ok) throw new Error('スコア履歴の読み込みに失敗しました。');
            
            const data = await response.json();
            scoresTbody.innerHTML = ''; // Clear existing rows
            weekDisplay.textContent = `${data.week_start} ~ ${data.week_end}`;

            const logsByDate = new Map(data.logs.map(log => [log.date, log]));
            
            for (let i = 0; i < 7; i++) {
                const day = new Date(data.week_start);
                // Adjust for timezone offset when creating date from string
                day.setMinutes(day.getMinutes() + day.getTimezoneOffset());
                day.setDate(day.getDate() + i);
                
                const dayString = toISODateString(day);
                const dayOfWeek = dayNames[day.getDay()];

                const log = logsByDate.get(dayString);
                
                const row = scoresTbody.insertRow();
                row.innerHTML = `
                    <td>${dayString}</td>
                    <td>${dayOfWeek}</td>
                    <td>${log ? log.score : '—'}</td>
                    <td>${log ? (log.note || '') : ''}</td>
                `;
            }
        } catch (error) {
            scoresTbody.innerHTML = `<tr><td colspan="4" class="error">${error.message}</td></tr>`;
        }
    };
    
    prevWeekBtn.addEventListener('click', () => {
        currentDate.setDate(currentDate.getDate() - 7);
        fetchAndDisplayScores(currentDate);
    });

    nextWeekBtn.addEventListener('click', () => {
        currentDate.setDate(currentDate.getDate() + 7);
        fetchAndDisplayScores(currentDate);
    });

    // Initial Load
    fetchAndDisplayScores(currentDate);
});
</script>
{% endblock %}
