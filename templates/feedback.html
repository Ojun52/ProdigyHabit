{% extends "base.html" %}

{% block title %}AIフィードバック - {{ super() }}{% endblock %}

{% block content %}
<article>
    <header>
        <h2>AIフィードバック</h2>
    </header>
    <p>過去7日間のあなたの生産性ログに基づいて、AIが激励的なフィードバックと具体的な改善案を提案します。</p>
    <button id="feedback-btn" aria-busy="false">フィードバックを取得</button>
    <div id="feedback-container" style="margin-top: 1.5rem;"></div>
</article>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const feedbackBtn = document.getElementById('feedback-btn');
    const feedbackContainer = document.getElementById('feedback-container');

    feedbackBtn.addEventListener('click', async () => {
        feedbackBtn.setAttribute('aria-busy', 'true');
        feedbackBtn.disabled = true;
        feedbackContainer.innerHTML = '';
        
        try {
            const response = await fetch('/api/feedback');
            const result = await response.json();

            if (response.ok) {
                feedbackContainer.innerHTML = marked.parse(result.feedback);
            } else {
                throw new Error(result.error || 'フィードバックの取得に失敗しました。');
            }
        } catch (error) {
            feedbackContainer.innerHTML = `<mark class="error">${error.message}</mark>`;
        } finally {
            feedbackBtn.setAttribute('aria-busy', 'false');
            feedbackBtn.disabled = false;
        }
    });
});
</script>
{% endblock %}
